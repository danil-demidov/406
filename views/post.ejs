<!DOCTYPE html>
<html lang="ru" data-theme="<%= theme %>">
<head>
    <meta charset="UTF-8">
    <title>Пост #<%= post.postid %></title>
    <link rel="stylesheet" href="/style.css">
    <style>
        body { margin: 0; }
        main.container { padding-left: 32px; padding-right: 32px; margin-top: 142px; }
        .post { background: var(--card-bg); padding: 1rem; margin-bottom: 1rem; border-radius: 5px; }
    </style>
</head>
<body>
    <header>
        <nav style="display: flex; align-items: center; justify-content: center; background: var(--primary-color); padding: 12px 0; position: relative;">
            <a href="/blog" style="position: absolute; left: 32px; top: 50%; transform: translateY(-50%);
                padding: 10px 20px; border-radius: 5px; background: var(--card-bg);
                color: var(--text-color); text-decoration: none; font-weight: bold;">
                ← Назад
            </a>
            <h2 style="margin: 0; color: #fff; font-size: 2rem; width: 100%; text-align: center;">Пост</h2>
            <button id="theme-btn" style="position: absolute; right: 32px; top: 50%; transform: translateY(-50%);
                padding: 10px 20px; border-radius: 5px; background: var(--card-bg); color: var(--text-color);
                border: none; font-weight: bold; cursor: pointer;">Сменить тему</button>
        </nav>
    </header>
    <main class="container">
        <div class="post" style="position:relative;">
            <strong>#<%= post.postid %> <span id="post-author"><%= post.author %></span></strong>
            <p id="post-text"><%= post.text %></p>
            <button id="edit-post-btn" title="Редактировать пост"
                style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--text-color-secondary);">
                ✎
            </button>
        </div>
        <div style="display: flex; align-items: flex-start; gap: 2rem;">
            <button id="add-comment-btn"
                style="background: var(--primary-color); color: #fff; border: none; border-radius: 5px; padding: 10px 20px; font-weight: bold; cursor: pointer;">
                Добавить комментарий
            </button>
            <div id="comments-list" style="flex: 1; margin-left: auto;"></div>
        </div>
    </main>
    <!-- Модальное окно для формы комментария -->
    <div id="modal-bg" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:1000;">
        <div id="modal-window" style="background:var(--card-bg); padding:2rem; border-radius:10px; max-width:400px; margin:10vh auto 0 auto; position:relative;">
            <!-- Форма будет вставлена через JS -->
        </div>
    </div>
    <script>
        // Смена темы
        document.getElementById('theme-btn').onclick = function() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            fetch('/theme', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'theme=' + newTheme
            });
        };

        // Работа с комментариями
        const postid = <%= post.postid %>;
        const addCommentBtn = document.getElementById('add-comment-btn');
        const modalBg = document.getElementById('modal-bg');
        const modalWindow = document.getElementById('modal-window');
        const editBtn = document.getElementById('edit-post-btn');
        const commentsList = document.getElementById('comments-list');

        function renderComments(comments) {
            commentsList.innerHTML = '';
            comments.forEach(comment => {
                const div = document.createElement('div');
                div.className = 'comment';
                div.style = 'background:var(--card-bg);margin-bottom:8px;padding:8px;border-radius:5px;position:relative;';
                div.innerHTML = `<strong>#${comment.commentid} ${comment.author}</strong><p>${comment.text}</p>`;

                // Кнопка "крестик"
                const closeBtn = document.createElement('button');
                closeBtn.innerHTML = '×';
                closeBtn.title = 'Удалить комментарий';
                closeBtn.style.position = 'absolute';
                closeBtn.style.top = '10px';
                closeBtn.style.right = '10px';
                closeBtn.style.background = 'none';
                closeBtn.style.border = 'none';
                closeBtn.style.fontSize = '1.2rem';
                closeBtn.style.cursor = 'pointer';
                closeBtn.style.color = 'var(--text-color-secondary)';
                closeBtn.onclick = (e) => {
                    e.stopPropagation();
                    fetch(`/api/comments/${comment.postid}/${comment.commentid}/hide`, { method: 'POST' })
                        .then(() => loadComments());
                };

                div.appendChild(closeBtn);
                commentsList.appendChild(div);
            });
        }

        function loadComments() {
            fetch(`/api/comments/${postid}`)
                .then(res => res.json())
                .then(renderComments);
        }
        loadComments();

        addCommentBtn.onclick = () => {
            modalBg.style.display = 'block';
            modalWindow.innerHTML = `
                <form id="comment-form" style="width:100%;">
                    <div style="display: flex; flex-direction: column; margin-bottom: 1rem;">
                        <label for="comment-author" style="margin-bottom: 4px;">Имя:</label>
                        <input type="text" id="comment-author" name="author" required>
                    </div>
                    <div style="display: flex; flex-direction: column; margin-bottom: 1rem;">
                        <label for="comment-text" style="margin-bottom: 4px;">Текст комментария:</label>
                        <textarea id="comment-text" name="text" required></textarea>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button type="submit"
                            style="background: var(--primary-color); color: #fff; border: none; border-radius: 5px; padding: 10px 20px; font-weight: bold; cursor: pointer;">
                            Сохранить
                        </button>
                        <button type="button" id="cancel-btn"
                            style="background: var(--card-bg); color: var(--text-color); border: 1px solid #ccc; border-radius: 5px; padding: 10px 20px; font-weight: bold; cursor: pointer;">
                            Отмена
                        </button>
                    </div>
                </form>
                <button id="close-modal" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:1.5rem;cursor:pointer;">×</button>
            `;

            document.getElementById('close-modal').onclick = () => {
                modalBg.style.display = 'none';
            };
            document.getElementById('cancel-btn').onclick = () => {
                modalBg.style.display = 'none';
            };

            document.getElementById('comment-form').onsubmit = function(e) {
                e.preventDefault();
                const author = document.getElementById('comment-author').value;
                const text = document.getElementById('comment-text').value;
                fetch(`/api/comments/${postid}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ author, text })
                }).then(() => {
                    modalBg.style.display = 'none';
                    loadComments();
                });
            };
        };

        // Клик вне окна — закрыть модалку
        modalBg.onclick = function(e) {
            if (e.target === modalBg) modalBg.style.display = 'none';
        };

        // Редактирование поста
        editBtn.onclick = () => {
            modalBg.style.display = 'block';
            modalWindow.innerHTML = `
                <form id="edit-post-form" style="width:100%;">
                    <div style="display: flex; flex-direction: column; margin-bottom: 1rem;">
                        <label for="edit-author" style="margin-bottom: 4px;">Имя:</label>
                        <input type="text" id="edit-author" name="author" required value="${document.getElementById('post-author').textContent}">
                    </div>
                    <div style="display: flex; flex-direction: column; margin-bottom: 1rem;">
                        <label for="edit-text" style="margin-bottom: 4px;">Текст поста:</label>
                        <textarea id="edit-text" name="text" required>${document.getElementById('post-text').textContent}</textarea>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button type="submit"
                            style="background: var(--primary-color); color: #fff; border: none; border-radius: 5px; padding: 10px 20px; font-weight: bold; cursor: pointer;">
                            Сохранить
                        </button>
                        <button type="button" id="cancel-edit-btn"
                            style="background: var(--card-bg); color: var(--text-color); border: 1px solid #ccc; border-radius: 5px; padding: 10px 20px; font-weight: bold; cursor: pointer;">
                            Отмена
                        </button>
                    </div>
                </form>
                <button id="close-edit-modal" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:1.5rem;cursor:pointer;">×</button>
            `;

            document.getElementById('close-edit-modal').onclick = () => {
                modalBg.style.display = 'none';
            };
            document.getElementById('cancel-edit-btn').onclick = () => {
                modalBg.style.display = 'none';
            };

            document.getElementById('edit-post-form').onsubmit = function(e) {
                e.preventDefault();
                const author = document.getElementById('edit-author').value;
                const text = document.getElementById('edit-text').value;
                fetch(`/api/posts/${postid}/edit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ author, text })
                }).then(() => {
                    document.getElementById('post-author').textContent = author;
                    document.getElementById('post-text').textContent = text;
                    modalBg.style.display = 'none';
                });
            };
        };
    </script>
</body>
</html>